# NFCツール プロジェクト仕様書

## 1. プロジェクト概要
本ツールは、NFCカード（NTAG21x系を想定）に対してプレイヤーデータの読み取り・書き込みを行うデスクトップアプリケーションである。ElectronとPythonを組み合わせて構築されており、リッチなUIとハードウェア（NFCリーダー）制御を両立している。

## 2. システム構成
- **フロントエンド**: HTML, CSS, JavaScript (Electron Renderer Process)
- **バックエンド**: Node.js (Electron Main Process)
- **デバイス制御**: Python 3.x (`pyscard` ライブラリ使用)
- **データベース**: MySQL (`mysql-connector-python` ライブラリ使用)
- **通信方式**:
    - Renderer ⇔ Main: Electron IPC (`contextBridge`経由)
    - Main ⇔ Python: 標準入出力 (`stdin`/`stdout`/`stderr`)

### ディレクトリ構造
- `main.js`: アプリケーションのエントリーポイント。ウィンドウ管理、Pythonプロセスの起動・監視を行う。
- `preload.js`: レンダラープロセスとメインプロセスの橋渡し（セキュリティ機能）。
- `index.html`: トップメニュー画面。
- `register.html` / `register.js`: ユーザー情報入力画面。
- `next.html` / `next.js`: ステータス確認・書き込み実行画面（隠しコマンド機能あり）。
- `read.html` / `read.js`: NFCデータの読み取り・表示画面。
- `monitor_nfc.py`: NFCカードの常時監視とデータ読み取りを行うPythonスクリプト。
- `nfc_writer.py`: NFCカードへのデータ書き込みおよびデータベースへの保存を行うPythonスクリプト。
- `.env`: データベース接続情報などの環境設定ファイル。

## 3. 機能一覧

### 3.1. トップメニュー (`index.html`)
- アプリケーションの開始画面。
- 以下の2つのアクションへの遷移ボタンを提供する。
    - **初期設定を開始**: 新規プレイヤーデータの登録フローへ遷移 (`register.html`)。
    - **NFCカードを読み取る**: 既存データの確認画面へ遷移 (`read.html`)。

### 3.2. データ登録フロー

#### 3.2.1. ユーザー情報入力 (`register.html`)
- **ニックネーム入力**: 最大20バイト（UTF-8）。リアルタイムでバイト数を計算し、超過時に警告を表示する。
- **年齢入力**: 0〜120歳の範囲で数値入力。
- **入力バリデーション**: 必須入力チェック、型チェック、範囲チェックを行う。
- **次へ**: 入力が正しければ、パラメータをURLクエリとして `next.html` へ渡して遷移する。

#### 3.2.2. ステータス設定・書き込み (`next.html`)
- **データ表示**: 前画面から引き継いだ「名前」と、初期値（所持金:100, 各ステータス:1）を表示。
- **隠しコマンド（デバッグ・管理者機能）**:
    - 特定の操作を行うことで、通常変更できないステータス値を編集するモーダルを表示する。
    - **発動条件**:
        - キーボード入力: "konami", "secret"
        - コナミコマンド: `↑↑↓↓←→←→BA`
        - ショートカット: `Ctrl+Shift+S` (Secret), `F12`
    - **機能**: カンマ区切りで数値を入力し、所持金やステータスを一括変更可能。
    - **リセット機能**: "reset"入力, `Ctrl+Shift+R`, `F11` で初期値に戻す。
- **書き込みと保存**:
    - 「NFCカードに登録」ボタンでプロセスを開始。
    - **NFC書き込み**: Pythonスクリプト (`nfc_writer.py`) を呼び出し、カードにデータを書き込む。
    - **DB保存**: 書き込み成功時、カードのUIDを取得し、MySQLデータベース (`player_status` テーブル) にデータを保存・更新 (UPSERT) する。
    - 完了時、成功メッセージを表示し、3秒後にトップメニューへ自動遷移。

### 3.3. データ読み取りフロー (`read.html`)
- 画面ロード時にNFC監視プロセス (`monitor_nfc.py`) をバックグラウンドで起動。
- **カード検知時**:
    - カード内のデータを読み取り、画面上のステータス欄（名前、パラメータ）に即座に反映。
    - インベントリデータが存在する場合、コンソールログに出力。
- **カード離脱時**:
    - 画面の表示データをクリアし、待機メッセージに戻す。
- 画面遷移時に監視プロセスを自動終了させ、リソースリークを防ぐ。

## 4. データ仕様 (NFCメモリマップ)
NFCカードのユーザーメモリ領域に対し、以下のページ割り当てでデータを格納する。
※ 1ページ = 4バイト

| 項目 | ページ番号 | データ長 | 備考 |
|---|---|---|---|
| **名前** | 4 - 8 | 20バイト | UTF-8エンコード。末尾はNULL埋め。 |
| **所持金 / パワー** | 9 | 2バイト / 2バイト | リトルエンディアン。上位/下位2バイトずつ。 |
| **スタミナ / スピード** | 10 | 2バイト / 2バイト | 同上 |
| **テクニック / ラック** | 11 | 2バイト / 2バイト | 同上 |
| **クラス** | 12 | 2バイト | 残り2バイトはパディング(0x00)。 |
| **インベントリ** | 13 - 39 | - | 予備領域として定義（現状は未使用または読み取りのみ）。 |

## 5. データベース仕様 (MySQL)
書き込み成功時に以下のテーブルにデータが保存される。

### テーブル名: `player_status`

| カラム名 | データ型 | NULL | Key | Default | 備考 |
|---|---|---|---|---|---|
| `player_id` | int | NO | PRI | NULL | auto_increment |
| `nfc_card_id` | varchar(255) | NO | UNI | NULL | カードのUID (ユニーク) |
| `user_name` | varchar(50) | NO | | NULL | |
| `age` | int | YES | | NULL | |
| `power` | int | NO | | 0 | |
| `stamina` | int | NO | | 0 | |
| `speed` | int | NO | | 0 | |
| `technique` | int | NO | | 0 | |
| `luck` | int | NO | | 0 | |
| `class` | int | NO | | 1 | |
| `money` | int | NO | | 0 | |
| `created_at` | datetime | NO | | CURRENT_TIMESTAMP | |
| `updated_at` | datetime | NO | | CURRENT_TIMESTAMP | 自動更新 |

## 6. エラーハンドリング
- **書き込み時**:
    - カード未検出、書き込み失敗、パラメータ不正などのエラーを捕捉し通知する。
    - **DB保存エラー**: データベース接続失敗や保存エラーが発生した場合、エラーログを出力するが、NFC書き込み自体が成功していればユーザーには「成功」として扱う（または警告を表示する）。
- **読み取り時**:

    - 読み取り中の切断やデータ破損を考慮し、エラーログを出力または無視して再試行する。
    - JSONパースエラー時は無視し、プロセスを継続させる。

## 7. 開発・実行環境
- **OS**: Windows (推奨), macOS, Linux
- **必須ランタイム**:
    - Node.js (Electron実行用)
    - Python 3.x
    - Pythonライブラリ:
        - `pyscard` (スマートカード制御用)
        - `mysql-connector-python` (DB接続用)
        - `python-dotenv` (環境変数管理用)
- **ハードウェア**: PC/SC対応のNFCリーダー/ライター (例: Sony PaSoRi RC-S380等)
- **データベース**: MySQL Server (8.0以上推奨)

## 8. 将来の拡張性 (TODO)
- インベントリ領域へのアイテムデータ書き込み機能の実装。
- 読み取り画面でのリッチなエフェクト追加。
- データベース連携を活用したランキングや履歴表示機能。

## 8. セットアップと起動方法

### 8.1. 事前準備
以下のソフトウェアがインストールされている必要があります。
- Node.js (v14以上推奨)
- Python (v3.x)
- PC/SC対応NFCリーダーのドライバ

### 8.2. インストール手順

#### 簡単セットアップ（推奨）
PowerShellスクリプトを使用して、一括でセットアップを行います。

1. **プロジェクトディレクトリへ移動**
   ```bash
   cd Project/digilive/nfc_tool
   ```

2. **セットアップスクリプトの実行**
   ```powershell
   .\setup.ps1
   ```
   ※ エラーが出る場合は、下記の手動インストールを試してください。

#### 手動インストール

1. **Node.js依存パッケージのインストール**
   ```bash
   npm install
   ```

2. **Python依存ライブラリのインストール**
   ```bash
   pip install pyscard mysql-connector-python python-dotenv
   ```

3. **環境設定ファイルの作成**
   プロジェクトルートにある `.env` ファイルを作成（または `.env.template` からコピー）し、データベース接続情報を設定します。

   ```ini
   DB_HOST=localhost
   DB_USER=root
   DB_PASSWORD=password
   DB_NAME=digilive_adv_db
   DB_PORT=3306
   ```

### 8.3. アプリケーションの起動

#### 基本的な起動方法

プロジェクトディレクトリで以下のコマンドを実行します。

```bash
npm start
```

または、Electronを直接起動する場合：

```bash
npx electron .
```

#### 実行時の動作

1. **アプリケーションウィンドウが開く**: Electronアプリケーションのウィンドウが表示されます。
2. **トップメニュー画面が表示される**: `index.html` が表示され、以下の2つのオプションが選択できます。
   - **初期設定を開始**: 新規プレイヤーデータの登録フローへ遷移
   - **NFCカードを読み取る**: 既存データの確認画面へ遷移

#### 実行前の確認事項

- ✅ Node.jsがインストールされている（`node --version`で確認）
- ✅ Pythonがインストールされている（`python --version`で確認）
- ✅ 必要なPythonライブラリがインストールされている（`pip list`で確認）
- ✅ `.env`ファイルが正しく設定されている
- ✅ MySQLサーバーが起動している（DB接続を使用する場合）
- ✅ NFCリーダーがUSB接続されている（NFC機能を使用する場合）

#### 開発モードでの実行

開発中にデバッグ情報を確認したい場合は、Electronの開発者ツールを開くことができます。

- アプリケーション起動後、`Ctrl+Shift+I`（Windows/Linux）または `Cmd+Option+I`（macOS）で開発者ツールを開けます。
- コンソールログやエラーメッセージを確認できます。

### 8.4. トラブルシューティング
- **「リーダーが見つかりません」というエラーが出る場合**:
  - NFCリーダーがUSB接続されているか確認してください。
  - ドライバが正しく当たっているか、デバイスマネージャーで確認してください。
- **Pythonエラーが出る場合**:
  - Pythonへのパスが通っているか確認してください。
  - 必要なライブラリ (`pyscard`, `mysql-connector-python`) がインストールされているか確認してください。
- **DB接続エラーが出る場合**:
  - `.env` ファイルの設定が正しいか確認してください。
  - MySQLサーバーが起動しているか、外部接続が許可されているか確認してください。
